<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tr√¨nh duy·ªát Dataverse</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    select, button { padding: 0.5rem; font-size: 1rem; margin-left: 0.5rem; }
    pre { background: #f6f6f6; padding: 1rem; border: 1px solid #ccc; margin-top: 1rem; white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <h2>üìÑ Tr√¨nh duy·ªát d·ªØ li·ªáu Dataverse</h2>

  <label for="table">Ch·ªçn b·∫£ng:</label>
  <select id="table">
    <option value="crdfd_employees">crdfd_employees</option>
    <option value="crdfd_saleorderdetails" selected>crdfd_saleorderdetails</option>
    <option value="crdfd_customers">crdfd_customers</option>
    <!-- th√™m b·∫£ng kh√°c t√πy b·∫°n -->
  </select>

  <button onclick="loadData()">T·∫£i d·ªØ li·ªáu</button>

  <pre id="output">üîÑ H√£y ch·ªçn b·∫£ng v√† b·∫•m ‚ÄúT·∫£i d·ªØ li·ªáu‚Äù.</pre>

  <script>
    async function loadData() {
      const output = document.getElementById("output");
      output.textContent = "‚è≥ ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶";

      const table = document.getElementById("table").value;

      const webhook = "https://prod-51.southeastasia.logic.azure.com:443/workflows/1db8c4d15497441287f7c888e8888ed4/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8smnu3fDoDarEJ1vXEJV5YTDTjhQMKNHrM_AGw3uqXs";

      const option = "?$top=1000";
      const columns = "&$select=crdfd_name,crdfd_trangthaionhang1,crdfd_khachhang,crdfd_nganhnghe,crdfd_tinhthanh,crdfd_productnum,crdfd_onvionhang,crdfd_gia,crdfd_onvitheokho,crdfd_ngaygiaodukientonghop,crdfd_tongtienchuavat,crdfd_gtgt,crdfd_tongtiencovat,cr1bb_nhanviensale,crdfd_saleorderdetailid,createdon";

      const crmUrl = "https://wecare-ii.crm5.dynamics.com/api/data/v9.2/" + table + option + columns;

      try {
        // B1. L·∫•y token t·ª´ Logic App
        const tokenResp = await fetch(webhook, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ targetUrl: crmUrl })
        });
        const token = await tokenResp.text();

        // B2. G·ªçi Dataverse
        const dataResp = await fetch(crmUrl, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Accept': 'application/json'
          }
        });

        const data = await dataResp.json();
        output.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        output.textContent = `‚ùå L·ªói: ${err.message}`;
      }
    }
  </script>
</body>
</html>
