<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Dataverse Browser</title>
  <style>
    body{font-family:system-ui,Arial,Helvetica,sans-serif;margin:2rem}
    .flex{display:flex;gap:0.75rem;align-items:center;margin-bottom:1rem}
    select,input,button{padding:0.5rem;font-size:1rem}
    pre{background:#f7f7f7;padding:1rem;border:1px solid #ddd;overflow:auto;max-height:70vh}
  </style>
</head>
<body>
  <h2>üìÑ Tr√¨nh duy·ªát d·ªØ li·ªáu Dataverse</h2>

  <!-- Ch·ªçn / nh·∫≠p LogicalName -->
  <div class="flex">
    <label for="table">Ch·ªçn b·∫£ng:&nbsp;</label>
    <select id="table">
      <option value="crdfd_saleorderdetails">crdfd_saleorderdetails</option>
      <option value="crdfd_employee">crdfd_employee</option>
      <!-- Th√™m b·∫£ng kh√°c t·∫°i ƒë√¢y -->
      <option value="__custom">‚üµ T·ª± nh·∫≠p</option>
    </select>
    <input id="customTable" placeholder="Nh·∫≠p LogicalName‚Ä¶" style="display:none;width:16rem">
    <button id="btnLoad">T·∫£i d·ªØ li·ªáu</button>
  </div>

  <pre id="output">H√£y ch·ªçn b·∫£ng v√† b·∫•m ‚ÄúT·∫£i d·ªØ li·ªáu‚Äù.</pre>

  <script>
    /* ====== T√πy ch·ªânh nhanh ====== */
    const LOGIC_APP   = 'https://prod-51.southeastasia.logic.azure.com/‚Ä¶sig=8smnu3fDoDarEJ1vXEJV5YTDTjhQMKNHrM_AGw3uqXs';
    const CRM_DOMAIN  = 'https://wecare-ii.crm5.dynamics.com';
    const MAX_TOP     = 1000;                   // s·ªë b·∫£n ghi m·ªói trang
    /* ================================= */

    // C·ªôt c·∫ßn l·∫•y (√°p d·ª•ng cho m·ªçi b·∫£ng; s·ª≠a l·∫°i n·∫øu c·∫ßn ri√™ng bi·ªát)
    const SELECT_COLUMNS = [
      'crdfd_name','createdon','modifiedon'
      // th√™m c·ªôt kh√°c...
    ].join(',');

    const tableSel   = document.getElementById('table');
    const customInput= document.getElementById('customTable');
    const output     = document.getElementById('output');
    const btnLoad    = document.getElementById('btnLoad');

    // Hi·ªán √¥ input n·∫øu user ch·ªçn ‚ÄúT·ª± nh·∫≠p‚Äù
    tableSel.addEventListener('change', () => {
      customInput.style.display = tableSel.value === '__custom' ? 'inline-block' : 'none';
    });

    btnLoad.addEventListener('click', () => {
      const tableName = tableSel.value === '__custom'
        ? customInput.value.trim()
        : tableSel.value;
      if (!tableName) { alert('Ch∆∞a nh·∫≠p t√™n b·∫£ng!'); return; }
      loadData(tableName);
    });

    async function loadData(table) {
      const show = msg => output.textContent = msg;
      try {
        show('‚è≥ L·∫•y token‚Ä¶');
        const baseUrl = `${CRM_DOMAIN}/api/data/v9.2/${table}?$top=${MAX_TOP}&$select=${encodeURIComponent(SELECT_COLUMNS)}`;

        /* --- 1. L·∫•y Access-Token qua Logic App --- */
        const tokenResp = await fetch(LOGIC_APP, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ targetUrl: baseUrl })
        });
        if (!tokenResp.ok) throw new Error(`Token error ${tokenResp.status}`);
        const token = await tokenResp.text();

        /* --- 2. G·ªçi Dataverse (ƒë√£ x·ª≠ l√Ω ph√¢n trang) --- */
        let url = baseUrl, all = [];
        while (url){
          show(`‚è≥ ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶ (${all.length})`);
          const resp = await fetch(url,{ headers:{Authorization:`Bearer ${token}`}});
          if (!resp.ok) throw new Error(`OData error ${resp.status}`);
          const json = await resp.json();
          all = all.concat(json.value);
          url = json['@odata.nextLink'];
        }

        /* --- 3. Hi·ªÉn th·ªã --- */
        show(JSON.stringify(all, null, 2));
      } catch (err) {
        show('‚ùå L·ªói: ' + err.message);
      }
    }
  </script>
</body>
</html>
