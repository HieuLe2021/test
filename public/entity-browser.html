<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>üìã Tr√¨nh duy·ªát b·∫£ng Dataverse</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    select, button { padding: 0.5rem; margin-right: 0.5rem; font-size: 1rem; }
    pre { background: #f8f8f8; padding: 1rem; border: 1px solid #ccc; white-space: pre-wrap; max-height: 80vh; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>üìã Ch·ªçn b·∫£ng Dataverse</h2>
  <div>
    <label>Ch·ªçn b·∫£ng:</label>
    <select id="entityDropdown"><option>‚è≥ ƒêang t·∫£i...</option></select>
    <button onclick="loadData()">T·∫£i d·ªØ li·ªáu</button>
  </div>
  <pre id="output">üîÑ ƒêang kh·ªüi t·∫°o‚Ä¶</pre>

  <script>
    const CRM_URL = "https://wecare-ii.crm5.dynamics.com";
    const LOGIC_APP = "https://prod-51.southeastasia.logic.azure.com:443/workflows/1db8c4d15497441287f7c888e8888ed4/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8smnu3fDoDarEJ1vXEJV5YTDTjhQMKNHrM_AGw3uqXs";
    const entityMap = {}; // LogicalName ‚Üí EntitySetName

    const dropdown = document.getElementById("entityDropdown");
    const output = document.getElementById("output");

    async function fetchEntityList() {
      output.textContent = "‚è≥ ƒêang t·∫£i danh s√°ch b·∫£ng‚Ä¶";

      const metadataUrl = `${CRM_URL}/api/data/v9.2/EntityDefinitions?$select=LogicalName,EntitySetName&$filter=IsCustomizable/Value eq true`;

      try {
        const token = await getToken(metadataUrl);

        const dataResp = await fetch(metadataUrl, {
          headers: { Authorization: "Bearer " + token }
        });
        const json = await dataResp.json();

        dropdown.innerHTML = "";
        json.value.forEach(entity => {
          const { LogicalName, EntitySetName } = entity;
          entityMap[LogicalName] = EntitySetName;

          const option = document.createElement("option");
          option.value = LogicalName;
          option.textContent = LogicalName;
          dropdown.appendChild(option);
        });

        output.textContent = `‚úÖ ƒê√£ t·∫£i ${json.value.length} b·∫£ng`;

      } catch (err) {
        output.textContent = "‚ùå L·ªói khi l·∫•y danh s√°ch b·∫£ng: " + err.message;
      }
    }

    async function getToken(targetUrl) {
      const tokenResp = await fetch(LOGIC_APP, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ targetUrl })
      });
      return await tokenResp.text();
    }

    async function getValidFields(logicalName, token) {
      const attrUrl = `${CRM_URL}/api/data/v9.2/EntityDefinitions(LogicalName='${logicalName}')/Attributes?$select=LogicalName,AttributeType`;

      const resp = await fetch(attrUrl, {
        headers: { Authorization: "Bearer " + token }
      });
      const json = await resp.json();

      // B·ªè c√°c field h·ªá th·ªëng
      const systemFieldNames = [
        "ownerid", "owneridtype", "owninguser", "owningbusinessunit",
        "statecode", "statuscode", "createdby", "createdon",
        "modifiedby", "modifiedon", "timezoneruleversionnumber",
        "versionnumber"
      ];

      // L·ªçc field th∆∞·ªùng (b·ªè lookup, h·ªá th·ªëng, xxxname)
      const normalFields = json.value
        .filter(attr =>
          !["Lookup", "Customer", "Owner", "PartyList", "Virtual"].includes(attr.AttributeType) &&
          !systemFieldNames.includes(attr.LogicalName.toLowerCase()) &&
          !attr.LogicalName.toLowerCase().endsWith("name")
        )
        .map(attr => attr.LogicalName);

      // Th√™m lookup d·∫°ng _xxx_value
      const lookupFields = json.value
        .filter(attr => ["Lookup", "Customer", "Owner"].includes(attr.AttributeType))
        .map(attr => `_${attr.LogicalName}_value`);

      // Tr·∫£ t·ªëi ƒëa 20 field
      return [...normalFields, ...lookupFields].slice(0, 20);
    }

    async function loadData() {
      const logical = dropdown.value;
      const entitySet = entityMap[logical];

      output.textContent = `‚è≥ L·∫•y token v√† danh s√°ch c·ªôt c·ªßa b·∫£ng ${logical}‚Ä¶`;

      try {
        const token = await getToken(CRM_URL);

        const fields = await getValidFields(logical, token);
        if (fields.length === 0) {
          output.textContent = "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c·ªôt h·ª£p l·ªá ƒë·ªÉ hi·ªÉn th·ªã.";
          return;
        }

        const selectClause = `?$select=${fields.join(",")}`;
        const dataUrl = `${CRM_URL}/api/data/v9.2/${entitySet}${selectClause}&$top=50`;

        output.textContent = `‚è≥ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ b·∫£ng ${logical}‚Ä¶`;

        const dataResp = await fetch(dataUrl, {
          headers: { Authorization: "Bearer " + token }
        });
        const json = await dataResp.json();
        output.textContent = JSON.stringify(json, null, 2);

      } catch (err) {
        output.textContent = "‚ùå L·ªói khi load d·ªØ li·ªáu: " + err.message;
      }
    }

    document.addEventListener("DOMContentLoaded", fetchEntityList);
  </script>
</body>
</html>
