<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“‹ TrÃ¬nh duyá»‡t báº£ng Dataverse</title>
  <style>
    body { font-family: Arial; margin: 2rem; }
    select, button { padding: 0.5rem; margin-right: 0.5rem; font-size: 1rem; }
    pre { background: #f8f8f8; padding: 1rem; border: 1px solid #ccc; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>ğŸ“‹ Chá»n báº£ng Dataverse</h2>
  <div>
    <label>Chá»n báº£ng:</label>
    <select id="entityDropdown"><option>â³ Äang táº£i...</option></select>
    <button onclick="loadData()">Táº£i dá»¯ liá»‡u</button>
  </div>
  <pre id="output">ğŸ”„ Äang khá»Ÿi táº¡oâ€¦</pre>

  <script>
    const CRM_URL = "https://wecare-ii.crm5.dynamics.com";
    const LOGIC_APP = "https://prod-51.southeastasia.logic.azure.com:443/workflows/1db8c4d15497441287f7c888e8888ed4/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8smnu3fDoDarEJ1vXEJV5YTDTjhQMKNHrM_AGw3uqXs";
    const entityMap = {}; // LogicalName â†’ EntitySetName

    const dropdown = document.getElementById("entityDropdown");
    const output = document.getElementById("output");

    async function fetchEntityList() {
      output.textContent = "â³ Äang táº£i danh sÃ¡ch báº£ngâ€¦";

      const metadataUrl = `${CRM_URL}/api/data/v9.2/EntityDefinitions?$select=LogicalName,EntitySetName&$filter=IsCustomizable/Value eq true`;

      try {
        const tokenResp = await fetch(LOGIC_APP, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ targetUrl: metadataUrl })
        });
        const token = await tokenResp.text();

        const dataResp = await fetch(metadataUrl, {
          headers: { Authorization: "Bearer " + token }
        });
        const json = await dataResp.json();

        dropdown.innerHTML = "";
        json.value.forEach(entity => {
          const { LogicalName, EntitySetName } = entity;
          entityMap[LogicalName] = EntitySetName;

          const option = document.createElement("option");
          option.value = LogicalName;
          option.textContent = LogicalName;
          dropdown.appendChild(option);
        });

        output.textContent = `âœ… ÄÃ£ táº£i ${json.value.length} báº£ng`;

      } catch (err) {
        output.textContent = "âŒ Lá»—i khi láº¥y danh sÃ¡ch báº£ng: " + err.message;
      }
    }

    async function getValidFields(logicalName, token) {
      const attrUrl = `${CRM_URL}/api/data/v9.2/EntityDefinitions(LogicalName='${logicalName}')/Attributes?$select=LogicalName&$top=15`;

      const resp = await fetch(attrUrl, {
        headers: { Authorization: "Bearer " + token }
      });
      const json = await resp.json();
      const fields = json.value.map(attr => attr.LogicalName);
      return fields;
    }

    async function loadData() {
      const logical = dropdown.value;
      const entitySet = entityMap[logical];

      output.textContent = `â³ Láº¥y token vÃ  danh sÃ¡ch cá»™t cá»§a báº£ng ${logical}â€¦`;

      try {
        // 1. Láº¥y token
        const tokenResp = await fetch(LOGIC_APP, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ targetUrl: CRM_URL }) // Dummy target
        });
        const token = await tokenResp.text();

        // 2. Láº¥y cá»™t há»£p lá»‡
        const fields = await getValidFields(logical, token);
        const selectClause = fields.length > 0 ? `?$select=${fields.join(",")}` : "";

        // 3. Gá»i data
        const dataUrl = `${CRM_URL}/api/data/v9.2/${entitySet}${selectClause}&$top=50`;

        output.textContent = `â³ Äang táº£i dá»¯ liá»‡u tá»« ${entitySet}â€¦`;

        const dataResp = await fetch(dataUrl, {
          headers: { Authorization: "Bearer " + token }
        });
        const json = await dataResp.json();
        output.textContent = JSON.stringify(json, null, 2);

      } catch (err) {
        output.textContent = "âŒ Lá»—i khi load dá»¯ liá»‡u: " + err.message;
      }
    }

    document.addEventListener("DOMContentLoaded", fetchEntityList);
  </script>
</body>
</html>
